#!/usr/bin/env bash
# Continuous Integration / Continuous Deployment tasks

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd -P)/envrc"

# VARs
DOCKER_PROJECT='vpm'
SSH_HOST='rhea.ghn.me'
SSH_USER='ubuntu'
SSH_KEY=$(mktemp 2>/dev/null || mktemp -t 'tmp')
PACKER_URL='https://releases.hashicorp.com/packer/1.0.0/packer_1.0.0_linux_amd64.zip'

# Install the VGS Library
install_vgs(){
  echo 'Install and load VGS library'
  git clone https://github.com/vghn/vgs.git ~/vgs
  # shellcheck disable=1090
  . ~/vgs/load 2>/dev/null || true
}

# Install gems
install_gems(){
  echo 'Install gems'
  bundle install --without development --path vendor/bundle
}

# Install AWS Command Line
install_aws_cli(){
  echo 'Install AWS-CLI'
  pip install --user --upgrade awscli
}

# Install HashiCorp Packer
install_packer(){
  echo 'Install HashiCorp Packer'
  curl -L -o packer.zip "$PACKER_URL"
  unzip -d ~/bin packer.zip
}

# Validate BASH scripts
validate_bash(){
  e_info 'Validate BASH scripts'
  find ./bin -type f -exec shellcheck {} +
}

# Validate CloudFormation templates
validate_cfn(){
  e_info 'Validate CloudFormation templates'
  find ./cfn \( -name '*.yaml' -o -name '*.json' \) -exec sh -c \
    'echo "Checking ${1}" && aws cloudformation validate-template --template-body "file://${1}" --output table' \
    -- {} \;
}

# Validate AMIs
validate_amis(){
  e_info 'Validate AMIs'
  eval "${APPDIR}/bin/ami" validate
}

# Set-up SSH
ssh_setup(){
  e_info 'Set-up SSH key'
  echo "$DEPLOY_RSA" | base64 --decode --ignore-garbage > "$SSH_KEY"
  chmod 600 "$SSH_KEY"

  e_info 'Update known hosts'
  ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
}

# Deploy RHEA
deploy_rhea(){
  ssh_setup

  e_info 'Upload docker-compose file'
  rsync -avz -e "ssh -i ${SSH_KEY}" --rsync-path 'sudo rsync' ./docker-compose.yml "${SSH_USER}@${SSH_HOST}:/var/local/vpm.yml"

  e_info 'Update docker-compose'
  # shellcheck disable=2029
  ssh -i "$SSH_KEY" "${SSH_USER}@${SSH_HOST}" "docker-compose --project-name ${DOCKER_PROJECT} --file /var/local/vpm.yml pull"
  # shellcheck disable=2029
  ssh -i "$SSH_KEY" "${SSH_USER}@${SSH_HOST}" "docker-compose --project-name ${DOCKER_PROJECT} --file /var/local/vpm.yml up -d --build --remove-orphans"
}

# CI Deploy
deploy(){
  if [[ "$ENVTYPE" == 'production' ]] && [[ "${TRAVIS_PULL_REQUEST:-false}" == 'false' ]]; then
    deploy_rhea
  else
    e_warn 'Deployment is only allowed in production!'
  fi
}

# Clean-up
clean_up() {
  if [[ -s "$SSH_KEY" ]]; then
    if [[ "$SSH_KEY" =~ tmp. ]]; then
      e_info 'Removing temporary ssh key'
      rm -rf "${SSH_KEY:?}"
    else
      e_warn 'Could not remove temporary ssh key'
    fi
  fi
}

# Trap exit
bye(){
  e_info 'Clean-up'
  clean_up; exit "${1:-0}"
}


main(){
  trap 'bye $?' EXIT HUP INT QUIT TERM

  # Process arguments
  case "${1:-}" in
    install)
      install_vgs
      ;;
    test)
      validate_bash
      ;;
    deploy)
      deploy
      ;;
    *)
      e_abort "USAGE: ${BASH_SOURCE[0]} [install | test | deploy]"
      ;;
  esac
}

main "${@:-}"
