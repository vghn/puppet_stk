#!/usr/bin/env bash
# Continuous Integration / Continuous Deployment tasks

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd -P)/envrc"

# Install the VGS Library
install_vgs(){
  echo 'Install and load VGS library'
  git clone https://github.com/vghn/vgs.git ~/vgs
  # shellcheck disable=1090
  . ~/vgs/load 2>/dev/null || true
}

# Install gems
install_gems(){
  echo 'Install gems'
  bundle install --without development --path vendor/bundle
}

# Install AWS Command Line
install_aws_cli(){
  echo 'Install AWS-CLI'
  pip install --user --upgrade awscli
}

# Install HashiCorp Packer
install_packer(){
  echo 'Install HashiCorp Packer'
  curl -L -o packer.zip 'https://releases.hashicorp.com/packer/0.12.1/packer_0.12.1_linux_amd64.zip'
  unzip -d ~/bin packer.zip
}

# Validate BASH scripts
validate_bash(){
  e_info 'Validate BASH scripts'
  find ./bin -type f -exec shellcheck {} +
}

# Validate CloudFormation templates
validate_cfn(){
  e_info 'Validate CloudFormation templates'
  find ./cfn \( -name '*.yaml' -o -name '*.json' \) -exec sh -c \
    'echo "Checking ${1}" && aws cloudformation validate-template --template-body "file://${1}" --output table' \
    -- {} \;
}

# Validate AMIs
validate_amis(){
  e_info 'Validate AMIs'
  eval "${APPDIR}/bin/ami" validate
}

# CI Deploy
deploy_rhea(){
  if [[ "$ENVTYPE" == 'production' ]] && [[ "${TRAVIS_PULL_REQUEST:-false}" == 'false' ]]; then
    e_info 'Set-up SSH key'
    SSH_KEY="$(mktemp)"
    echo "$DEPLOY_RSA" | base64 --decode --ignore-garbage > "$SSH_KEY"
    chmod 600 "$SSH_KEY"

    e_info 'Update known hosts'
    ssh-keyscan -H puppet.ghn.me >> ~/.ssh/known_hosts

    e_info 'Update docker-compose'
    ( ssh -i "$SSH_KEY" ubuntu@puppet.ghn.me 'docker-compose --project-name vpm --file - pull' ) < docker-compose.yml
    ( ssh -i "$SSH_KEY" ubuntu@puppet.ghn.me 'docker-compose --project-name vpm --file - up -d' ) < docker-compose.yml

    if [[ -s "$SSH_KEY" ]] && [[ "$SSH_KEY" =~ tmp. ]]; then
      e_info 'Removing temporary ssh key'
      rm -rf "${SSH_KEY:?}"
    else
      e_warn 'Could not remove temporary ssh key'
    fi
  else
    e_warn 'SSH deployment is only allowed in production!'
  fi
}

# Process arguments
case "${1:-}" in
  install)
    install_vgs
    ;;
  test)
    validate_bash
    ;;
  deploy)
    deploy_rhea
    ;;
  *)
    e_abort "USAGE: ${BASH_SOURCE[0]} [install | test | deploy]"
    ;;
esac
