#!/usr/bin/env bash
# Stack CLI

# Load environment
# shellcheck disable=1090
. "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd -P)/envrc"

# Usage
usage(){
  echo '---------------------------------------------'
  echo "USAGE: ${BASH_SOURCE[0]} [COMMAND] [OPTIONS]"
  echo '---------------------------------------------'
  echo 'Commands:'
  echo ''
  echo '  - deploy [stack name]'
  echo '    * Allowed stacks: monitor, unifi'
  echo ''
  echo '----------------------------------------------'
  echo 'For more information please consult the README'
  echo '----------------------------------------------'
  exit 1
}

# Process Stack CLI
stack_process_cli(){
  trap 'bye $?' EXIT HUP INT QUIT TERM
  if [[ -z $1 ]]; then usage; fi

  local cmd stack
  cmd="${1:-}"; shift || true
  stack="${1:-}"; shift || true

  # Defaults
  export SSH_USER='deploy'

  case "$cmd" in
    deploy)
      case "$stack" in
        monitor)
          export SSH_HOST='prometheus.ghn.me'
          ;;
        unifi)
          export SSH_HOST='unifi.mec7.com'
          ;;
        *)
          usage
      esac
      deploy_swarm "$stack"
      ;;
    *)
      usage
      ;;
  esac
}

stack_process_cli "${@:-}"
