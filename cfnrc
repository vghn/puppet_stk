#!/usr/bin/env bash
# AWS CloudFormation Defaults

# Defaults
process_cfn(){
  local stack A P T
  stack="${1:-}"

  # Default command arguments
  A=''

  # Common paramaters
  P="'ParameterKey=EnvType,ParameterValue=${ENVTYPE}'"

  # Common tags
  T="     'Key=Group,Value=${AWS_TAG_GROUP:-vgh}'"
  T="${T} 'Key=Project,Value=${AWS_TAG_PROJECT:-vgh}'"

  # Other
depends_on=

  # Stack defaults
  case "$stack" in
    billing)
      name='BillingAlarms'
      file='billing.yml'
      P="${P} 'ParameterKey=AlarmThresholds,ParameterValue=\"1,2,3,4,5\"'"
      P="${P} 'ParameterKey=RecipientEmailAddress,ParameterValue=${NOTIFICATION_EMAIL:-}'"
      ;;
    billing2018)
      export AWS_PROFILE='aws2018'
      name='BillingAlarms'
      file='billing.yml'
      P="${P} 'ParameterKey=AlarmThresholds,ParameterValue=\"1,2,3,4,5\"'"
      P="${P} 'ParameterKey=RecipientEmailAddress,ParameterValue=${NOTIFICATION_EMAIL:-}'"
      ;;
    cloudtrail)
      name='CloudTrail'
      file='cloudtrail.yml'
      A='--capabilities CAPABILITY_NAMED_IAM'
      P="${P} 'ParameterKey=CloudWatchLogsRetentionInDays,ParameterValue=${AWS_LOG_RETENTION_DAYS:-14}'"
      ;;
    docker_cloud)
      export AWS_PROFILE='default'
      name='DockerCloud'
      file='docker_cloud.yml'
      A='--capabilities CAPABILITY_NAMED_IAM'
      ;;
    notifications)
      name='Notifications'
      file='notifications.yml'
      P="${P} 'ParameterKey=NotificationEmail,ParameterValue=${NOTIFICATION_EMAIL:-}'"
      ;;
    prometheus)
      export AWS_PROFILE='aws2018'
      name='Prometheus'
      file='prometheus/main.yml'
      depends_on='prometheus-iam,prometheus-sg'
      P="${P} 'ParameterKey=KeyName,ParameterValue=vgh'"
      P="${P} 'ParameterKey=ImageID,ParameterValue=ami-43a15f3e'"
      # P="${P} 'ParameterKey=ImageID,ParameterValue=\"$(vgs_aws_ec2_get_ubuntu_official_ami_id)\"'"
      P="${P} 'ParameterKey=InstanceType,ParameterValue=t2.micro'"
      ;;
    prometheus-iam)
      export AWS_PROFILE='aws2018'
      name='PrometheusIAM'
      file='prometheus/iam.yml'
      A='--capabilities CAPABILITY_NAMED_IAM'
      P="${P} 'ParameterKey=AssetsBucket,ParameterValue=${PROMETHEUS_ASSETS_BUCKET:-prometheus}'"
      ;;
    prometheus-sg)
      export AWS_PROFILE='aws2018'
      name='PrometheusSG'
      file='prometheus/sg.yml'
      depends_on='vpc2018'
      P="${P} 'ParameterKey=TrustedIPs,ParameterValue=\"${TRUSTED_IPS:-\"$(vgs_get_external_ip)/32\"}\"'"
      ;;
    puppetdb)
      export AWS_PROFILE='aws2018'
      name='PuppetDB'
      file='puppet/db.yml'
      depends_on='vpc2018,puppetsg'
      P="${P} 'ParameterKey=DBName,ParameterValue=${PP_DB_NAME:-puppetdb}'"
      P="${P} 'ParameterKey=DBUser,ParameterValue=${PP_DB_USER:-puppetdb}'"
      P="${P} 'ParameterKey=DBPassword,ParameterValue=${PP_DB_PASS:-puppetdb}'"
      ;;
    puppetsg)
      export AWS_PROFILE='aws2018'
      name='PuppetSG'
      file='puppet/sg.yml'
      depends_on='vpc2018'
      P="${P} 'ParameterKey=TrustedIPs,ParameterValue=\"${TRUSTED_IPS:-\"$(vgs_get_external_ip)/32\"}\"'"
      ;;
    vbot)
      export AWS_PROFILE='aws2018'
      name='VBot'
      file='vbot.yml'
      depends_on=''
      A='--capabilities CAPABILITY_NAMED_IAM'
      ;;
    vgh)
      export AWS_PROFILE='default'
      name='VGH'
      file='vgh.yml'
      depends_on='prometheus-iam'
      A='--capabilities CAPABILITY_NAMED_IAM'
      P="${P} 'ParameterKey=AssetsBucketName,ParameterValue=${AWS_VGH_ASSETS_BUCKET}'"
      P="${P} 'ParameterKey=BackupBucketName,ParameterValue=${AWS_VGH_BACKUP_BUCKET}'"
      P="${P} 'ParameterKey=SecretsBucketName,ParameterValue=${AWS_VGH_SECRETS_BUCKET}'"
      P="${P} 'ParameterKey=PrometheusInstanceRoleArn,ParameterValue=\"$(AWS_PROFILE=aws2018 vgs_aws_cfn_get_output PrometheusIAM InstanceRoleArn)\"'"
      ;;
    vpc)
      export AWS_PROFILE='default'
      name='VPC'
      file='vpc.yml'
      ;;
    vpc2018)
      export AWS_PROFILE='aws2018'
      name='VPC'
      file='vpc.yml'
      ;;
    vpc2017a)
      export AWS_PROFILE='aws2017a'
      name='VPC'
      file='vpc.yml'
      ;;
    *)
      usage
      ;;
  esac

  e_info "This stack depends on: ${depends_on}"
  export cfn_cmd="--stack-name ${name} --template-body file://${AWS_CFN_STACKS_PATH}/${file} ${A} --parameters ${P} --tags ${T}"
}

clear_cfn(){
  unset stack name file depends_on A P T cfn_cmd
}
