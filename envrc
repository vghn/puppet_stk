#!/usr/bin/env bash

# Bash strict mode
set -euo pipefail
IFS=$'\n\t'

# DEBUG
[ -z "${DEBUG:-}" ] || set -x

# VARs
SSH_KEY=$(mktemp 2>/dev/null || mktemp -t 'tmp')
ENCRYPT_KEY="${ENCRYPT_KEY:-$(echo "$TRAVIS_KEY_STACK" | base64)}"
PACKER_URL='https://releases.hashicorp.com/packer/1.1.3/packer_1.1.3_linux_amd64.zip'
export SSH_KEY ENCRYPT_KEY PACKER_URL

# System VARs
APPDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
TMPDIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'tmp')
NOW="$(date +"%Y%m%d_%H%M%S")"
VERSION=$(git describe --always --tags)
AWS_CFN_STACKS_PATH="${APPDIR}/cfn"
AWS_AMI_PACKER_PATH="${APPDIR}/ami"
export APPDIR TMPDIR NOW VERSION AWS_CFN_STACKS_PATH AWS_AMI_PACKER_PATH

# Load private environment
if [[ -s "${APPDIR}/.env" ]]; then
  # shellcheck disable=1090
  . "${APPDIR}/.env" 2>/dev/null || true
elif [[ -s "${APPDIR}/.env.gpg" ]]; then
  # shellcheck disable=1090
  . <( ( echo "$ENCRYPT_KEY" | base64 --decode ) |  gpg --batch --yes --decrypt --passphrase-fd 0 "${APPDIR}/.env.gpg" ) 2>/dev/null || true
fi

# Load VGS library (https://github.com/vghn/vgs)
# shellcheck disable=1090
. ~/vgs/load 2>/dev/null || echo 'VGS library is required' 1>&2

# Load functions
if [[ -d "${APPDIR}/shlib" ]]; then
  # shellcheck disable=1090
  for file in ${APPDIR}/shlib/*.sh; do . "$file"; done
fi

# Detect environment
detect_environment 2>/dev/null || true
detect_ci_environment 2>/dev/null || true
ENVTYPE="${ENVTYPE:-production}"

# Load AWS AMI Build environment
# shellcheck disable=1090
. "${APPDIR}/amirc" 2>/dev/null || true

# Load AWS CloudFormation environment
# shellcheck disable=1090
. "${APPDIR}/cfnrc" 2>/dev/null || true
