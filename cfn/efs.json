{
  "Description": "VGH EFS v0.0.1",

  "Parameters": {
    "EnvType": {
      "Type": "String",
      "Description": "The environment type",
      "Default": "production"
    },
    "VolumeName": {
      "Description": "The name to be used for the EFS volume",
      "Type": "String",
      "Default": "EFS"
    },
    "NumberOfAZs": {
        "Description": "Number of Availability Zones to use in the VPC. This must match the number of zones in existing in the region.",
        "Type": "String",
        "AllowedValues": ["2", "3", "4"],
        "Default": "2"
    },
    "SubnetIDs": {
      "Description": "The list of subnet ids",
      "Type": "List<AWS::EC2::Subnet::Id>"
    },
    "SecurityGroupIDs": {
      "Description": "The list of security group ids",
      "Type": "List<AWS::EC2::SecurityGroup::Id>"
    }
  },

  "Conditions": {
    "3AZCondition": {
      "Fn::Or": [
        {"Fn::Equals": [{"Ref": "NumberOfAZs"}, "3"]},
        {"Condition": "4AZCondition"}
      ]
    },
    "4AZCondition": {"Fn::Equals": [{"Ref": "NumberOfAZs"}, "4"]}
  },

  "Resources": {
    "EFS": {
      "Type": "AWS::EFS::FileSystem",
      "Properties": {
        "FileSystemTags": [
          {"Key": "Name", "Value": {"Ref": "VolumeName"}}
        ]
      }
    },

    "MountTarget1": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {"Ref": "EFS"},
        "SubnetId": {"Fn::Select": ["0", {"Ref": "SubnetIDs"}]},
        "SecurityGroups": {"Ref": "SecurityGroupIDs" }
      }
    },

    "MountTarget2": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {"Ref": "EFS"},
        "SubnetId": {"Fn::Select": ["1", {"Ref": "SubnetIDs"}]},
        "SecurityGroups": {"Ref": "SecurityGroupIDs" }
      }
    },

    "MountTarget3": {
      "Condition": "3AZCondition",
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {"Ref": "EFS"},
        "SubnetId": {"Fn::Select": ["2", {"Ref": "SubnetIDs"}]},
        "SecurityGroups": {"Ref": "SecurityGroupIDs" }
      }
    },

    "MountTarget4": {
      "Condition": "4AZCondition",
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {"Ref": "EFS"},
        "SubnetId": {"Fn::Select": ["3", {"Ref": "SubnetIDs"}]},
        "SecurityGroups": {"Ref": "SecurityGroupIDs" }
      }
    }
  },

  "Outputs": {
    "VolumeID": {
      "Description": "The ID of the EFS volume",
      "Value": {"Ref": "EFS"}
    },
    "MountTarget1" : {
      "Description" : "1st Mount target ID",
      "Value" :  { "Ref" : "MountTarget1" }
    },
    "MountTarget2" : {
      "Description" : "2nd Mount target ID",
      "Value" :  { "Ref" : "MountTarget2" }
    },
    "MountTarget3" : {
      "Condition": "3AZCondition",
      "Description" : "3rd Mount target ID",
      "Value" :  { "Ref" : "MountTarget3" }
    },
    "MountTarget4" : {
      "Condition": "4AZCondition",
      "Description" : "4th Mount target ID",
      "Value" :  { "Ref" : "MountTarget4" }
    }
  }
}
