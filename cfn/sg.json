{
  "Description": "VGH SG v0.0.1",

  "Parameters": {
    "VPCId": {
      "Description": "The VPC ID",
      "Type": "AWS::EC2::VPC::Id"
    },
    "SSHLocations" : {
      "Type": "CommaDelimitedList",
      "Description" : "The IP address ranges that can be used to SSH to the EC2 instances"
    }
  },

  "Resources": {
    "ELBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "ELB Firewall",
        "VpcId": {"Ref": "VPCId"}
      }
    },
    "ELBSecurityGroupAllowHTTPS": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["ELBSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "443", "ToPort": "443", "CidrIp": "0.0.0.0/0"
      }
    },
    "ELBSecurityGroupAllowPuppet": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["ELBSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "8140", "ToPort": "8140", "CidrIp": "0.0.0.0/0"
      }
    },

    "RheaSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Rhea Firewall",
        "VpcId": {"Ref": "VPCId"}
      }
    },
    "RheaSecurityGroupAllowSelf": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "SourceSecurityGroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}
      }
    },
    "RheaSecurityGroupAllowELB": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "0", "ToPort": "65535", "SourceSecurityGroupId": {"Fn::GetAtt": ["ELBSecurityGroup", "GroupId"]}
      }
    },
    "RheaSecurityGroupAllowSSH1": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": { "Fn::Select" : [ "0", {"Ref": "SSHLocations"} ] }
      }
    },

    "DBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "RDS Firewall",
        "VpcId": {"Ref": "VPCId"}
      }
    },
    "DBSecurityGroupAllowRheaAccesstoPostgreSQL": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["DBSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "5432", "ToPort": "5432", "SourceSecurityGroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}
      }
    },
    "DBSecurityGroupAllowSSH1AccesstoPostgreSQL": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["DBSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "5432", "ToPort": "5432", "CidrIp": { "Fn::Select" : [ "0", {"Ref": "SSHLocations"} ] }
      }
    },

    "EFSSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "EFS Firewall",
        "VpcId": {"Ref": "VPCId"}
      }
    },
    "EFSSecurityGroupAllowRhea": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {"Fn::GetAtt": ["EFSSecurityGroup", "GroupId"]}, "IpProtocol": "tcp", "FromPort": "2049", "ToPort": "2049", "SourceSecurityGroupId": {"Fn::GetAtt": ["RheaSecurityGroup", "GroupId"]}
      }
    }
  },

  "Outputs": {
    "ELBSecurityGroup": {
      "Description": "The Elastic Load Balancer security group",
      "Value": {"Ref" : "ELBSecurityGroup"}
    },
    "RheaSecurityGroup": {
      "Description": "The Puppet Master of Masters security group",
      "Value": {"Ref" : "RheaSecurityGroup"}
    },
    "DBSecurityGroup": {
      "Description": "The Relational Database Service security group",
      "Value": {"Ref" : "DBSecurityGroup"}
    },
    "EFSSecurityGroup": {
      "Description": "The Elastic File System security group",
      "Value": {"Ref" : "EFSSecurityGroup"}
    }
  }
}
